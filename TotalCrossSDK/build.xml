<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE project   [
<!ENTITY common SYSTEM "common.xml">
]>
<!--
/*********************************************************************************
 *  TotalCross Software Development Kit                                          *
 *  Copyright (C) 2000-2012 SuperWaba Ltda.                                      *
 *  All Rights Reserved                                                          *
 *                                                                               *
 *  This library and virtual machine is distributed in the hope that it will     *
 *  be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of    *
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                         *
 *                                                                               *
 *********************************************************************************/

-->

<project name="TotalCross" default="help" basedir=".">

<property name="sdk.root"  value="${basedir}"/>

<description>
  This build file is used to build the TotalCross SDK.
</description>
	
<!-- import ANT Contrib -->
<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        setup all build process properties.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->	
	
<property name="src"                    value="${sdk.root}/src/main/java"/>
<property name="resources"              value="${sdk.root}/src/main/resources"/>
<property name="etc"                    value="${sdk.root}/etc"/>
<property name="docs"                   value="${sdk.root}/docs"/>
<property name="fonts"                  value="${etc}/fonts"/>
<property name="tools"                  value="${etc}/tools"/>
<property name="output"                 value="${sdk.root}/../../temp"/>
<property name="target"                 value="${sdk.root}/../../output"/>
<property name="dist"                   value="${sdk.root}/dist"/>
<property name="lb.src"                 value="${sdk.root}/../LitebaseSDK/src/java"/>
<property name="sqlite-jdbc"            value="sqlite-jdbc-3.8.7"/>

<!-- defined alxjoin task -->	
<taskdef name="alxjoin" classname="tc.tools.ant.AlxJoin" classpath="${tools}/ant/tctasks.jar" />
<!-- define proguard task -->
<taskdef name="proguard" classname="proguard.ant.ProGuardTask" classpath="${etc}/obfuscator/proguard.jar" />
	
<!-- load platform environment variables -->
<property environment="env"/>

<!-- set host platform properties -->
<condition property="os.win32" value="true">
 <os family="windows"/>
</condition>
<condition property="os.linux" value="true">
 <os family="unix"/>
</condition>

<property name="compile.listfiles"       value="no"/>
<property name="compile.target"          value="7"/>
<property name="compile.source"          value="7"/>
<property name="compile.debug"           value="yes"/>
<property name="compile.optimize"        value="yes"/>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 get-version

-description:
        retrieves the TotalCross version from the file "totalcross/sys/Settings.java"
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

  <!-- +comment out this whole block if you don't have Ant 1.6 or later -->
<loadfile srcfile="${src}/totalcross/sys/Settings.java" property="versionStr">
	<filterchain>
		<linecontains>
			<contains value="versionStr"/>
		</linecontains>
		<striplinebreaks/>
		<tokenfilter>
			<replacestring from="public" to=""/>
			<replacestring from="static" to=""/>
			<replacestring from="String" to=""/>
			<replacestring from="versionStr" to=""/>
			<replacestring from="=" to=""/>
			<deletecharacters chars='";'/>
			<trim/>
		</tokenfilter>
	</filterchain>
</loadfile>
<loadfile srcfile="${src}/totalcross/sys/Settings.java" property="versionNumber">
	<filterchain>
		<linecontains>
			<contains value="int version"/>
		</linecontains>
		<striplinebreaks/>
		<tokenfilter>
			<replacestring from="public" to=""/>
			<replacestring from="static" to=""/>
			<replacestring from="int" to=""/>
			<replacestring from="version" to=""/>
			<replacestring from="=" to=""/>
			<deletecharacters chars=';'/>
			<trim/>
		</tokenfilter>
	</filterchain>
</loadfile>
<!-- -comment out this whole block if you don't have Ant 1.6 or later -->

<!-- define the default version number -->
<property name="versionStr" value="X.XX"/>
<property name="versionNumber" value="100"/>

<!-- this target displays a help message which documents this configuration file features -->
<target name="help" depends="info">
   <echo message="Type 'ant -p' to list all available targets."/>
</target>
   
<target name="info">
   <echo message="Host platform is ${os.name}"/>
   <echo message="TotalCross version: '${versionStr} (${versionNumber})'"/>
</target>   
	
<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: build

-description:
        build everything
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="build" depends="info,device,desktop,desktop_web" description="build everything">
</target>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: clean

-description:
        remove the build folder
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="clean" depends="info">
	<available file="${output}" property="output.exists" />
	<if>
	 	<equals arg1="${output.exists}" arg2="true" />
	<then>
		<delete includeemptydirs="true">
			<fileset dir="${output}">
				<include name="**/*"/>
				<exclude name="**/eclipse/**/*"/>
			</fileset>
		</delete>
	</then>
	</if>
</target>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: compile

-description:
        compile the TotalCross SDK
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="compile-device" 
      description="compiles everything for devices">

  <echo message="compile the TotalCross SDK with JDK ${ant.java.version}"/>
  <mkdir dir="${output}/classes" />
  <mkdir dir="${output}/devicesrc" />
  <copy todir="${output}/devicesrc" overwrite="true" preservelastmodified="true">
     <fileset dir="${src}" excludes="tc/tools/InvalidateIPA.java,totalcross/zxing/**,totalcross/android/**,**/*4A.*,**/*4B*" />
     <fileset dir="${src}" includes="ras/CompilationDate4B.java" />
  </copy>
  <replaceregexp file="${output}/devicesrc/tc/Deploy.java" flags="gs" match="//\$START:REMOVE-ON-SDK-GENERATION\$.*?//\$END:REMOVE-ON-SDK-GENERATION\$" replace="" />

  <javac srcdir="${output}/devicesrc"
     sourcepath=""
     encoding="ISO-8859-1"
     debug="${compile.debug}"
     optimize="${compile.optimize}"
     target="${compile.target}"
     source="${compile.source}"
     destdir="${output}/classes"
     excludes="tc/samples/xml/rpc/server/**, totalcross/pim/**, tc/samples/pimal/**"
     nowarn="true"
  	includeAntRuntime="false"
  >
     <classpath>
        <pathelement location="${tools}/sqlite/${sqlite-jdbc}.jar"/>
        <pathelement location="${tools}/jdeb/lib/ant.jar"/>
        <pathelement location="${tools}/jdeb/jdeb-0.7.jar"/>
        <pathelement location="${etc}/libs/bouncycastle/bcpkix-jdk15on-147.jar"/>
        <pathelement location="${etc}/libs/bouncycastle/bcprov-jdk15on-147.jar"/>
        <pathelement location="${etc}/libs/commons/commons-io-2.2.jar"/>
        <pathelement location="${tools}/ipa/dd-plist.jar"/>
        <pathelement location="${etc}/libs/truezip/truezip-driver-file-7.5.1.jar"/>
        <pathelement location="${etc}/libs/truezip/truezip-driver-zip-7.5.1.jar"/>
        <pathelement location="${etc}/libs/truezip/truezip-file-7.5.1.jar"/>
        <pathelement location="${etc}/libs/truezip/truezip-kernel-7.5.1.jar"/>
        <pathelement location="${etc}/libs/truezip/truezip-swing-7.5.1.jar"/>
     	<pathelement location="${etc}/libs/appdirs-1.0.0.jar"/>
     	<pathelement location="${etc}/libs/jna-4.2.2.jar"/>
     	<pathelement location="${etc}/libs/jna-platform-4.2.2.jar"/>
     	<pathelement location="${etc}/libs/slf4j-api-1.7.21.jar"/>
     </classpath>
  </javac>

  <delete dir="${output}/devicesrc"/>

</target>
  
<target name="compile-desktop" 
      description="compiles everything for desktop">

  <echo message="compile the TotalCross SDK for desktop with JDK ${ant.java.version}"/>
  <mkdir dir="${output}/classes_desktop" />
  <mkdir dir="${output}/desktopsrc" />
  <copy todir="${output}/desktopsrc" overwrite="true" preservelastmodified="true">
     <fileset dir="${src}" excludes="**/*4A.*,**/*4B.*,**/*4D.*,totalcross/zxing/,totalcross/android/,tc/tools/InvalidateIPA.java,tc/samples/**,tc/test/**,ras/**,**/*4B$*" />
     <fileset dir="${src}" includes="ras/ActivationClient.java,ras/ActivationException.java" />
  </copy>
  
  <!-- remove some code that we won't allow people outside the company to have. -->
  <replaceregexp file="${output}/desktopsrc/tc/Deploy.java" flags="gs" match="//\$START:REMOVE-ON-SDK-GENERATION\$.*?//\$END:REMOVE-ON-SDK-GENERATION\$" replace="" />

  <echo message="Removing 4D and 4B methods" />
  <taskdef name="removemethod" classname="tc.tools.ant.RemoveMethod" classpath="${etc}/tools/ant/tctasks.jar" />
  <removemethod methodname=".+(4B|4D)" keeporiginal="false">
    <fileset dir="${output}/desktopsrc" includes="**/*.java" excludes="tc/**/*" />
  </removemethod>
    
  <!-- copy the totalcross.lang and util classes. They are needed by the converter. -->
  <copy todir="${output}/desktopsrc" overwrite="true" preservelastmodified="true" >
     <fileset dir="${src}" includes="totalcross/util/*4D.java" />
     <fileset dir="${src}" includes="totalcross/lang/**" excludes="**/*4B.*" />
     <fileset dir="${src}" includes="jdkcompat/**/*.java,jdkcompatx/**/*.java" />
  </copy>
  <replaceregexp file="${output}/desktopsrc/totalcross/ui/MainWindow.java" flags="gs" match="//\$START:REMOVE-ON-SDK-GENERATION\$.*?//\$END:REMOVE-ON-SDK-GENERATION\$" replace="" />

  <javac srcdir="${output}/desktopsrc"
     sourcepath=""
     encoding="ISO-8859-1"
     debug="${compile.debug}"
     optimize="${compile.optimize}"
     target="${compile.target}"
     source="${compile.source}"
     destdir="${output}/classes_desktop"
     excludes="tc/samples/xml/rpc/server/**, totalcross/pim/**, tc/samples/pimal/**"
     nowarn="true"
  	includeAntRuntime="false"
  >
  	
    <classpath>
       <pathelement location="${tools}/sqlite/${sqlite-jdbc}.jar"/>
       <pathelement location="${tools}/jdeb/lib/ant.jar"/>
       <pathelement location="${tools}/jdeb/jdeb-0.7.jar"/>
       <pathelement location="${etc}/libs/bouncycastle/bcpkix-jdk15on-147.jar"/>
       <pathelement location="${etc}/libs/bouncycastle/bcprov-jdk15on-147.jar"/>
       <pathelement location="${etc}/libs/commons/commons-io-2.2.jar"/>
       <pathelement location="${tools}/ipa/dd-plist.jar"/>
       <pathelement location="${etc}/libs/truezip/truezip-driver-file-7.5.1.jar"/>
       <pathelement location="${etc}/libs/truezip/truezip-driver-zip-7.5.1.jar"/>
       <pathelement location="${etc}/libs/truezip/truezip-file-7.5.1.jar"/>
       <pathelement location="${etc}/libs/truezip/truezip-kernel-7.5.1.jar"/>
       <pathelement location="${etc}/libs/truezip/truezip-swing-7.5.1.jar"/>
     	<pathelement location="${etc}/libs/appdirs-1.0.0.jar"/>
     	<pathelement location="${etc}/libs/jna-4.2.2.jar"/>
     	<pathelement location="${etc}/libs/jna-platform-4.2.2.jar"/>
     	<pathelement location="${etc}/libs/slf4j-api-1.7.21.jar"/>
    </classpath>  	
  </javac>

  <delete dir="${output}/desktopsrc"/>

  <!-- copy some other files to the classes folder -->
  <copy todir="${output}/classes_desktop">
     <fileset dir="${src}" includes="**/*.png,**/*.gif"/>
     <fileset dir="${resources}" includes="**/*.png,**/*.gif"/>
  </copy>

</target>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: desktop

-description:
        build the TotalCross desktop package
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="desktop" depends="compile-desktop" description="build the tc.jar">

  <echo message="create the desktop jar file" />
  <mkdir dir="${dist}" />
  <delete file="${dist}/tc_desktop.jar"/>
  <delete file="${dist}/tc_deploy.jar"/>
  <delete file="${dist}/tc_deploy_intermediario.jar"/>
  <jar destfile="${dist}/tc_deploy_intermediario.jar" compress="no" update="no">
    <fileset dir="${output}/classes_desktop"
    includes="tc/**"
    excludes="totalcross/**,tc/samples/**,*.tcz"
    />
  </jar>

   <proguard warn="false" shrink="false" allowaccessmodification="false" defaultpackage="z" optimize="false" overloadaggressively="true" obfuscate="true" verbose="true" ignorewarnings="true" printmapping="${dist}/desktop_${versionStr}.map">
       <keep name="*"><field/><method/></keep>
       <keep name="tc.tools.converter.ConverterException" />
       <keep name="tc.Help"><field  access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.Deploy"><field  access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.Deploy$*"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.LinuxBuildNatives"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.LinuxBuildNatives$*"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.IPhoneBuildNatives"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.IPhoneBuildSource"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.IPhoneBuildSource$ER"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.Deployer4IPhone$*"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.zip.BlackHoleOutputStream"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.zip.Deployer4WP8$CopyZipFilter"><field access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.deployer.bzip2.*"><field access="public protected" /><method access="public protected" /></keep> 
       <keep name="tc.tools.NativeMethodsPrototypeGenerator"><field  access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.FontGenerator"><field  access="public protected" /><method access="public protected" /></keep>
       <keep name="tc.tools.RegisterSDK*"><field  access="public" /><method access="public" /></keep>
       <keep name="tc.tools.SW2TC"><field access="public protected" /><method access="public protected" /></keep>
       <!-- keep some method names, otherwise Hashtable class and dump will not work. -->
       <keepclassmembernames>
         <method name="toString" />
         <method name="equals" />
         <method name="hashCode" />
         <method name="finalize" />
       </keepclassmembernames>

       <injar path="${dist}/tc_deploy_intermediario.jar" />
       <libraryjar path ="${java.home}/lib/rt.jar"/>
       <outjar path="${dist}/tc_deploy.jar" />
   </proguard>

  <delete file="${dist}/tc_deploy_intermediario.jar"/>

  <!-- we have to jar the totalcross api separately because proguard changes the method's access and breaks Litebase generation. -->
  <jar destfile="${dist}/tc_desktop.jar" compress="yes" update="yes" includes="totalcross/**,org/json/simple/**">
    <fileset dir="${output}/classes_desktop"
    excludes="tc/**,*.tcz"
    />  
    <fileset dir="${fonts}" includes="TCFont.tcz"/>      
  </jar>
 
  <!-- join tc_t.jar and sqlite.jar into tc.jar -->
  
   <jar destfile="${dist}/tc.jar" filesetmanifest="skip">
       <zipgroupfileset file="${dist}/tc_desktop.jar"/>
       <zipgroupfileset file="${dist}/tc_deploy.jar"/>
       <zipgroupfileset file="${tools}/sqlite/${sqlite-jdbc}.jar"/>
  	<manifest>
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Implementation-Vendor" value="SuperWaba Ltda"/>
      <attribute name="Implementation-Title" value="Totalcross"/>
      <attribute name="Implementation-Version" value="${versionStr}"/>
      <!-- support "java -jar tc.jar" to run deployment -->
      <attribute name="Main-Class" value="tc.Help"/>
  	</manifest>
   </jar>
   <delete file="${dist}/tc_desktop.jar" />
   <delete file="${dist}/tc_deploy.jar" />
   
  <chmod file="${dist}/tc.jar" perm="ugo+x"></chmod>

</target>

<target name="desktoplb" depends="desktop" description="builds tc.jar joined with litebase.jar">
   <jar destfile="${dist}/tc_.jar">
       <zipgroupfileset file="${dist}/tc.jar"/>
       <zipgroupfileset file="${sdk.root}/../../Litebase/LitebaseSDK/dist/litebase.jar"/>
     	<manifest>
         <attribute name="Built-By" value="${user.name}"/>
         <attribute name="Implementation-Vendor" value="SuperWaba Ltda"/>
         <attribute name="Implementation-Title" value="Totalcross"/>
         <attribute name="Implementation-Version" value="${versionStr}"/>
         <!-- support "java -jar tc.jar" to run deployment -->
         <attribute name="Main-Class" value="tc.Help"/>
     	</manifest>
   </jar>
   <delete file="${dist}/tc.jar" />
   <move file="${dist}/tc_.jar" tofile="${dist}/tc.jar" />
</target>
<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: desktop

-description:
        build the TotalCross web jar used in browsers
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="desktop_web" depends="compile-desktop" description="build the tcweb.jar">

  <echo message="create the web jar file" />
  <mkdir dir="${dist}" />
  <delete file="${dist}/tcweb.jar"/>
  <delete file="${dist}/tcweb_.jar"/>
  <copy file="${fonts}/TCFont.tcz" todir="${output}/classes_desktop"/>
  <jar destfile="${dist}/tcweb.jar" compress="yes" update="no">
    <fileset dir="${output}/classes_desktop"
    excludes="tc/**,PostInstall.class"
    />
  	<manifest>
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Implementation-Vendor" value="SuperWaba Ltda"/>
      <attribute name="Implementation-Title" value="Totalcross"/>
      <attribute name="Implementation-Version" value="${versionStr}"/>
      <!-- support "java -jar tc_web.jar" to run deployment -->
      <attribute name="Main-Class" value="totalcross.Launcher"/>
  	</manifest>
  </jar>

  <signjar jar="${dist}/tcweb.jar"
     alias="tcandroidkey" keystore="${etc}/security/tcandroidkey.keystore"
     storepass="@ndroid$w" keypass="@ndroidsw"
     preservelastmodified="true">
  </signjar>
  <chmod file="${dist}/tcweb.jar" perm="ugo+x"></chmod>

</target>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: javadoc

-description:
        build the TotalCross Javadocs
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="replaceJavaLang">
  <replace dir="${output}/javadoc/" >
  	<include name="**/*.java"/>
	<replacefilter
		token="(${str} "
		value="(totalcross.lang.${str} "/>
	<replacefilter
		token=",${str} "
		value=",totalcross.lang.${str} "/>
  	<replacefilter
  		token=" class ${str} "
  		value=" class%%${str} "/>
	<replacefilter
		token=" ${str} "
		value=" totalcross.lang.${str} "/>
	<replacefilter
		token="${str}["
		value="totalcross.lang.${str}["/>
	<replacefilter
		token="java.lang.${str}"
		value="totalcross.lang.${str}"/>
	<replacefilter
		token=" class%%${str} "
		value=" class ${str} "/>
  </replace>
</target>

<target name="javadoc" description="build the javadoc.">

  <mkdir dir="${docs}/html" />
  <delete>
    <fileset dir="${docs}/html" excludes="*.gif"/>
  </delete>

  <delete failonerror="false"><fileset dir="${output}/javadoc"/></delete>
  <mkdir dir="${output}/javadoc" />

  <!-- join lb javadoc -->  
  <copy todir="${output}/javadoc"><fileset dir="${lb.src}" excludes="**/*4D*,tc/**,litebase/android/**"/></copy>
  <replace dir="${output}/javadoc/litebase" token="native public" value="//native public"><include name="**/*.java"/></replace>
  <replace dir="${output}/javadoc/litebase" token="public static native" value="//public static native"><include name="**/*.java"/></replace>
  <replace dir="${output}/javadoc/litebase" token="native static" value="//native static"><include name="**/*.java"/></replace>

  <copy todir="${output}/javadoc">
    <fileset dir="${src}" excludes="**/*4A*,**/*4B*,**/*4D*,tc/**,ras/**,totalcross/pim/**,totalcross/zxing/**,totalcross/android/**,totalcross/sql/sqlite4j/**"/>
  </copy>
  <echo message="Removing 4D methods" />
  <taskdef name="removemethod" classname="tc.tools.ant.RemoveMethod" classpath="${etc}/tools/ant/tctasks.jar" />
  <removemethod methodname=".+(4D)" keeporiginal="false">
    <fileset dir="${output}/javadoc" includes="totalcross/**/*.java" />
  </removemethod>
  
  <!-- +hack to generate java.lang package documentation -->
  <copy todir="${output}/javadoc/totalcross/lang">
    <fileset dir="${src}/totalcross/lang"/>
    <globmapper from="*4D.java" to="*.java"/>
  </copy>
  <delete file="${output}/javadoc/totalcross/lang/Array4D.java" />

  <replace dir="${output}/javadoc/totalcross/lang" token="4D"><include name="**/*.java"/></replace>
  <!-- -hack -->

  <!-- replace java.lang.* to totalcross.lang.* so the user goes to the correct package when viewing the javadoc. -->
  <antcall target="replaceJavaLang"><param name="str" value="Class"/></antcall>
  <antcall target="replaceJavaLang"><param name="str" value="StringBuffer"/></antcall>
  <antcall target="replaceJavaLang"><param name="str" value="String"/></antcall>
  <antcall target="replaceJavaLang"><param name="str" value="Object"/></antcall>
  <antcall target="replaceJavaLang"><param name="str" value="Runnable"/></antcall>
  <antcall target="replaceJavaLang"><param name="str" value="Thread"/></antcall>
  <antcall target="replaceJavaLang"><param name="str" value="Throwable"/></antcall>

  <exec dir="${java.home}/bin" executable="javadoc">
    <arg line="-sourcepath ${output}/javadoc"/>
    <arg line="-d ${docs}/html"/>
    <arg line="-doctitle 'TotalCross SDK ${versionStr}.${buildNumber} (&lt;a href=changelogs.html _target=blank &gt;changelogs&lt;/a&gt;).'"/>
    <arg line="-source 1.7"/>
    <arg line="-subpackages litebase -subpackages totalcross"/>
  </exec>

  <!-- replace all references in the javadocs, even if they don't create a link. -->
  <replace dir="${docs}/html/" token="java.lang." value="totalcross.lang."><include name="**/*.html"/></replace>

  <delete failonerror="false"><fileset dir="${output}/javadoc"/></delete>

  <copy file="${docs}/changelogs.html" todir="${docs}/html"/>

  <!--replace file="${docs}/html/changelogs.html" token="@@@" value="@@BUILD_NUMBER@@"/-->

</target>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: device

-description:
        build the TotalCross TCBase.tcz device
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="device" depends="compile-device" description="build the TCBase.tcz">

  <echo message="create the device TCBase.tcz file" />
  <mkdir dir="${dist}" />
  
  <!-- all but ui classes -->
  <copy file="${src}/totalcross/chartypes.bin" todir="${output}/classes/totalcross"/>
  <jar destfile="${output}/tcsdk2_.jar" compress="yes" update="no">
    <fileset dir="${output}/classes"
    includes="totalcross/firebase/**/*.class,totalcross/telephony/*.class,totalcross/io/sync/*.class,totalcross/money/*.class,totalcross/util/*.class,totalcross/util/pdf/*.class,totalcross/util/regex/*.class,totalcross/lang/*.class,totalcross/lang/reflect/*.class,totalcross/chartypes.bin,ras/**/*.class,totalcross/db/**/*.class,totalcross/sql/*.class,totalcross/phone/**/*.class,totalcross/mail/**/*.class,totalcross/crypto/**/*.class,totalcross/barcode/**/*.class,totalcross/json/**/*.class,totalcross/MainClass.class,totalcross/Service.class,totalcross/game/*.class,totalcross/io/*.class,totalcross/lang/*.class,totalcross/net/*.class,totalcross/sys/*.class,totalcross/unit/*.class,totalcross/map/*.class,totalcross/util/concurrent/*.class,totalcross/xml/*.class,totalcross/json/*.class,totalcross/io/device/*.class,totalcross/io/device/gps/*.class,totalcross/io/device/scanner/*.class,totalcross/io/device/gps/garmin/*.class,totalcross/net/ssl/*.class,totalcross/util/tcz/*.class,totalcross/util/zip/*.class,totalcross/xml/rpc/*.class,totalcross/xml/soap/*.class,totalcross/io/device/printer/*.class,totalcross/net/mail/*.class,totalcross/io/device/bluetooth/*.class,org/json/simple/*.class,org/json/simple/parser/*.class,jdkcompat/**/*.class,jdkcompatx/**/*.class"
    excludes="totalcross/zxing/**,totalcross/android/**,**/*4A*,totalcross/TCEventThread*,totalcross/ui/*.class,totalcross/ui/chart/*.class,totalcross/ui/event/*.class,totalcross/ui/font/*.class,totalcross/ui/gfx/*.class,totalcross/ui/html/*.class,totalcross/ui/image/*.class,totalcross/ui/media/*.class,totalcross/ui/anim/*.class,totalcross/ui/html/ui/*.class,totalcross/ui/tree/*.class,totalcross/ui/dialog/*.class,totalcross/res/**"
    />
  </jar>

   <proguard warn="false" shrink="false" allowaccessmodification="false" optimize="false" overloadaggressively="false" obfuscate="true" verbose="true" ignorewarnings="true" printmapping="${dist}/device_${versionStr}.map">
       <keep name="*"><field access="public protected" /></keep>
       <keepclassmembers>
         <method name="*" />
         <field access="!public !protected !private" />
       </keepclassmembers>
       <keepattribute name="LineNumberTable" />

       <injar path="${output}/tcsdk2_.jar" />
   	 <libraryjar path ="${java.home}/lib/rt.jar"/>
       <outjar path="${output}/tcsdk2.jar" />
   </proguard>

  <echo message="deploy the non-UI jar package file" />
  <java classname="tc.Deploy" fork="yes" dir="${output}">
    <classpath>
        <pathelement location="${output}/classes"/>
        <pathelement location="${sdk.root}"/>
    </classpath>
    <arg value="${output}/tcsdk2.jar"/>
    <arg line="/n TCBase"/>
    <arg line="${tcdeploy_line}"/>
    <arg line="-win32"/>
    <arg line="/a TCvm"/>
    <arg line="/r 5443444B314891CE3D2DD791"/>
  </java>

  <copy file="${output}/install/win32/TCBase.tcz" todir="${dist}/vm"/>
  
  <!-- ui classes -->
  
  <jar destfile="${output}/tcsdk2_.jar" compress="yes" update="no">
    <fileset dir="${output}/classes"
    includes="totalcross/res/**,totalcross/ui/*.class,totalcross/ui/chart/*.class,totalcross/ui/event/*.class,totalcross/ui/font/*.class,totalcross/ui/gfx/*.class,totalcross/ui/html/*.class,totalcross/ui/image/*.class,totalcross/ui/media/*.class,totalcross/ui/anim/*.class,totalcross/ui/html/ui/*.class,totalcross/ui/tree/*.class,totalcross/ui/dialog/*.class"
    />
    <fileset dir="${src}" includes="totalcross/res/**/*.mp3,totalcross/res/**/*.gif,totalcross/res/**/*.png" />
  	<fileset dir="${resources}" includes="totalcross/res/**/*.mp3,totalcross/res/**/*.gif,totalcross/res/**/*.png" />
  </jar>

   <proguard warn="false" shrink="false" allowaccessmodification="false" optimize="false" overloadaggressively="false" obfuscate="true" verbose="true" ignorewarnings="true" printmapping="${dist}/device_${versionStr}.map">
       <keep name="*"><field access="public protected" /></keep>
       <keepclassmembers>
         <method name="*" />
         <field access="!public !protected !private" />
       </keepclassmembers>
       <keepattribute name="LineNumberTable" />

       <injar path="${output}/tcsdk2_.jar" />
   	 <libraryjar path ="${java.home}/lib/rt.jar"/>
       <outjar path="${output}/tcsdk2.jar" />
   </proguard>

  <echo message="deploy the UI jar package file" />
  <java classname="tc.Deploy" fork="yes" dir="${output}">
    <classpath>
        <pathelement location="${output}/classes"/>
        <pathelement location="${sdk.root}"/>
    </classpath>
    <arg value="${output}/tcsdk2.jar"/>
    <arg line="/n TCUI"/>
    <arg line="${tcdeploy_line}"/>
    <arg line="-win32"/>
    <arg line="/a TCvm"/>
    <arg line="/r 5443444B314891CE3D2DD791"/>
  </java>

  <copy file="${output}/install/win32/TCUI.tcz" todir="${dist}/vm"/>

   
  <copy file="${fonts}/TCFont.tcz" todir="${dist}/vm"/>

</target>

<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
target: samples

-description:
        build the TotalCross samples
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<target name="samples" depends="compile-device" description="build all the samples">
   <delete dir="${dist}/samples" failonerror="no" />
   <mkdir dir="${dist}/samples" />

   <property name="samples.includes" value="tc/samples"/>
   <copy todir="${output}/classes" verbose="true">
      <fileset dir="${src}" casesensitive="no" includes="**/*.gif, **/*.bmp, **/*.pkg, **/*.mp3, **/*.tcz, **/*.png, **/*.jpeg, **/*.jpg, **/*.wav, **/*.pdb, **/*.txt, **/*.htm*"/>
   	<fileset dir="${resources}" casesensitive="no" includes="**/*.gif, **/*.bmp, **/*.pkg, **/*.mp3, **/*.tcz, **/*.png, **/*.jpeg, **/*.jpg, **/*.wav, **/*.pdb, **/*.txt, **/*.htm*"/>
   </copy>

   <subant target="deploy-app" inheritall="yes">
      <fileset dir="${src}" includes="${samples.includes}/**/subbuild.xml" />
   </subant>
</target>

<target name="deploy-app">

   <echo message="deploy the ${app.name} package file" />
   <property name="target.dir" value="${dist}/samples/${app.name}" />
   <mkdir dir="${target.dir}" />

   <!-- win32 packaging not supported on Linux -->
   <condition property="supportedPlatforms" value="-iphone -linux">
	<os family="unix"/>
   </condition>
   <property name="supportedPlatforms" value="-all"/>	
	
	<java classname="tc.Deploy" fork="yes" dir="${target.dir}">
      <classpath>
           <pathelement location="${output}/classes"/>
           <pathelement location="${sdk.root}"/>
	       <pathelement location="${tools}/jdeb/lib/ant.jar"/>
	       <pathelement location="${tools}/jdeb/lib/bcpg-jdk16-143.jar"/>
	       <pathelement location="${tools}/jdeb/lib/bcprov-jdk16-143.jar"/>
 	       <pathelement location="${tools}/jdeb/jdeb-0.7.jar"/>
       </classpath>
       <arg value="${output}/classes/tc/samples/${app.srcdir}/${app.name}.class"/>
       <arg line="${tcdeploy_line}"/>
       <arg line="${supportedPlatforms}"/>
       <arg line="/r 5443444B314891CE3D2DD791"/>
   </java>
   <delete failonerror="false"><fileset dir="${target.dir}" includes="*.*,${app.name},start"/></delete>
</target>

</project>
